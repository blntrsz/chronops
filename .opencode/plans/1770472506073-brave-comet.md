# Plan: assessment domain (template + instance)

## Decisions (locked)
- Target entity: Control only
- Template fields: name, description, workflow status
- Instance fields: name, status (planned/in_progress/completed/failed), due date (nullable), workflow status
- No evidence linking in MVP

## Domain layer
- Add `packages/domain/src/assessment-template.ts`
  - Types: `AssessmentTemplateId`, `AssessmentTemplateStatus` (draft/active/archived)
  - Model: id, controlId, name, description (nullable), status, Base fields
  - Workflow template same transitions as control/framework
  - Functions: id generator, make/update/remove, not-found error
- Add `packages/domain/src/assessment-instance.ts`
  - Types: `AssessmentInstanceId`, `AssessmentInstanceStatus` (planned/in_progress/completed/failed)
  - Model: id, templateId, controlId, name, dueDate (nullable DateTimeUtc), status, workflowStatus, Base fields
  - Workflow template for workflowStatus (draft/active/archived)
  - Functions: id generator, make/update/remove, not-found error
- Export from `packages/domain/src/index.ts`
- Add domain tests (pattern in `packages/domain/src/test/*.test.ts`)

## Core layer
- SQL tables
  - New file `packages/core/src/assessment/sql.ts` with `assessment_template` + `assessment_instance`
  - Fields snake_case; include Base fields + orgId
  - Indexes on control_id, template_id, org_id
- DB registry: add tables in `packages/core/src/db.ts`
- Migrations: new `packages/core/migrations/0002_*_assessment.sql` to create both tables
- Services
  - `packages/core/src/assessment/template/service.ts` CRUD + list(filter by controlId)
  - `packages/core/src/assessment/instance/service.ts` CRUD + list(filter by controlId, templateId)
  - Follow patterns in `packages/core/src/control/service.ts`
- Contracts
  - `packages/core/src/assessment/template/contract.ts` CRUD RPCs
  - `packages/core/src/assessment/instance/contract.ts` CRUD RPCs
  - Pagination payloads use `Pagination` + optional filters
- Handlers
  - `packages/core/src/assessment/template/handler.ts`
  - `packages/core/src/assessment/instance/handler.ts`
  - Wire into `packages/core/src/contract.ts` and `packages/core/src/rpc.ts`

## Web layer
- Atoms: `packages/web/src/features/assessment/_atom.tsx`
  - list/create/update/remove for template + instance
- Routes
  - `packages/web/src/routes/org/$slug/assessment/index.tsx` (templates list)
  - `packages/web/src/routes/org/$slug/assessment/$id.tsx` (template detail + instances list)
  - `packages/web/src/routes/org/$slug/assessment-instance/$id.tsx` (instance detail)
- Features
  - `packages/web/src/features/assessment/list-templates.tsx`
  - `packages/web/src/features/assessment/create-template.tsx`
  - `packages/web/src/features/assessment/list-instances.tsx`
  - `packages/web/src/features/assessment/create-instance.tsx`
  - Reuse `OrgListLayout`, `DataTable`, `GhostInput/GhostTextArea`, `useAutosaveFields`
  - Template create requires control selection
- Nav
  - Add “Assessments” link in `packages/web/src/widgets/sidebar/app-sidebar.tsx`
  - Add quick action in control detail to create assessment template for that control

## Verification
- If tests added: `bun test` in `packages/domain`
- Optional typecheck: `bun run tsc --noEmit` in `packages/domain`

## Unresolved questions
- none
