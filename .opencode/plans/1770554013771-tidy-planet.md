# Plan: Event domain + audit log + subscriptions

## Intent
- Introduce DomainEvent model in domain layer.
- Persist all domain events to event table (audit log).
- Provide RPC API for list events.
- Use drizzle sql.ts schema; generate SQL migration from it.

## Constraints + inputs
- Migrations via drizzle: define in `packages/core/src/*/sql.ts`, generate to `packages/core/migrations/*.sql`.
- Event fields: id, name, actor, org, typestamp, revisionIdBefore, revisionId.
- Event name scheme: `entity.action` (e.g. `issue.created`, `audit.run.completed`).
- No payload in events.
- Scope now: Domain + tables + service + RPC. No emitters wired into other services yet.

## Plan (build from primitives)
1) Domain Event model
   - Add `packages/domain/src/event.ts`.
   - Define `DomainEvent` schema with required fields:
     - `id` (EventId), `name`, `actorId`, `orgId`, `typeStamp`,
       `revisionIdBefore`, `revisionId`, `entityType`, `entityId`.
   - Provide `eventId()` helper (ULID + `evt_` prefix) similar to other domains.
   - Provide `makeEvent()` helper: accept base+actor+entity meta.
   - Export from `packages/domain/src/index.ts`.

2) Drizzle schema + migration
   - Create `packages/core/src/event/sql.ts` with:
     - `eventTable` (audit log):
       - columns: id (pk), name, actorId, orgId, typeStamp, payload (jsonb),
         revisionIdBefore (nullable), revisionId, entityType, entityId.
       - indexes: orgId, typeStamp (desc), actorId, entityType+entityId.
   - Add tables to `packages/core/src/db.ts` schema list.
   - Generate migration: `cd packages/core && bun run db generate` (drizzle-kit).

3) Core service
   - Add `packages/core/src/event/service.ts` with:
     - `append(event: DomainEvent)` -> insert into eventTable.
     - `listEvents(pagination, filters)` -> org-scoped query by actorId/name/entity.
   - Use Actor orgId scoping like other services.
   - Return domain types (DomainEvent).

4) RPC surface
   - Add `packages/core/src/event/contract.ts` (RpcGroup):
     - `EventList` (paginated, filters: name?, actorId?, entityType?, entityId?).
   - Add `packages/core/src/event/handler.ts` to bind service.
   - Wire into `packages/core/src/contract.ts` + `packages/core/src/rpc.ts` layers.

5) Tests
   - If existing pattern: add minimal tests in core for service list/create.
   - Otherwise skip tests for first slice; note manual verify in plan.

## Files (expected to change/add)
- Add: `packages/domain/src/event.ts`
- Update: `packages/domain/src/index.ts`
- Add: `packages/core/src/event/sql.ts`
- Add: `packages/core/src/event/service.ts`
- Add: `packages/core/src/event/contract.ts`
- Add: `packages/core/src/event/handler.ts`
- Update: `packages/core/src/db.ts`
- Update: `packages/core/src/contract.ts`
- Update: `packages/core/src/rpc.ts`
- Add: `packages/core/migrations/0006_*.sql` (drizzle generate)

## Verification
- Generate migration: `cd packages/core && bun run db generate`.
- Typecheck: `cd packages/core && bun run typecheck`.
- Lint/fix required by repo: `bun scan:fix` (root).

## Unresolved questions
- None.
