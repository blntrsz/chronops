# Tag Primitive Implementation Plan

## Overview

Implement the Tag primitive as defined in docs/primitives.md: "label for search and filter"

## Files to Create/Modify

### 1. Domain Layer

**File:** `packages/domain/src/tag.ts` (NEW)

- TagId branded type + factory
- TagName schema (validated string)
- TagColor schema (optional hex color for UI)
- Tag entity with: id, name, color
- CreateTag, UpdateTag schemas
- make(), update(), remove() effect functions
- TagNotFoundError

**File:** `packages/domain/src/index.ts` (MODIFY)

- Add: `export * as Tag from "./tag";`

### 2. Database Layer

**File:** `packages/core/migrations/0003_tag.ts` (NEW)

- Create `tag` table with base fields + name, color
- Create index on (org_id, name) for filtering
- Create `entity_tag` junction table for many-to-many:
  - entity_id (string, polymorphic - can reference any entity)
  - tag_id (foreign key to tag)
  - Composite PK (entity_id, tag_id)
  - Index on (org_id, entity_id) for lookups

### 3. Service Layer

**File:** `packages/core/src/tag/service.ts` (NEW)

- TagService class with Effect.Service
- Methods:
  - `insert(CreateTag) -> Tag`
  - `update(id, UpdateTag) -> Tag`
  - `remove(id) -> void`
  - `getById(id) -> Option<Tag>`
  - `list() -> Array<Tag>` (org-scoped)
  - `listByEntity(entityId) -> Array<Tag>`
  - `attachToEntity(entityId, tagId) -> void`
  - `detachFromEntity(entityId, tagId) -> void`

### 4. RPC Contract

**File:** `packages/core/src/tag/contract.ts` (NEW)

- TagCreate, TagUpdate, TagRemove RPCs
- TagById, TagList RPCs
- TagListByEntity RPC
- TagAttach, TagDetach RPCs

### 5. Handler

**File:** `packages/core/src/tag/handler.ts` (NEW)

- TagHandler wiring contract to service

### 6. Wiring

**File:** `packages/core/src/contract.ts` (MODIFY)

- Merge TagContract into RpcContract

**File:** `packages/core/src/rpc.ts` (MODIFY)

- Add TagHandler to HandlersLayer
- Provide TagService.Default

## Schema Design

```typescript
// Tag
{
  id: TagId,           // e.g., "tag_01HF..."
  name: string,        // e.g., "urgent", "approved"
  color: string?,      // e.g., "#FF5733" (optional)
  ...Base fields
}

// EntityTag (junction)
{
  entityId: string,    // polymorphic - any entity ID
  tagId: TagId,
  ...Base fields
}
```

## SQL Migration

```sql
-- Tag table
CREATE TABLE IF NOT EXISTS tag (
  id VARCHAR(255) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  color VARCHAR(7),
  org_id VARCHAR(255) NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at TIMESTAMPTZ,
  created_by VARCHAR(255) NOT NULL DEFAULT 'system',
  updated_by VARCHAR(255) NOT NULL DEFAULT 'system',
  deleted_by VARCHAR(255),
  hash VARCHAR(255) NOT NULL DEFAULT 'system'
);

CREATE INDEX IF NOT EXISTS tag_org_name_idx ON tag(org_id, name);

-- EntityTag junction table
CREATE TABLE IF NOT EXISTS entity_tag (
  entity_id VARCHAR(255) NOT NULL,
  tag_id VARCHAR(255) NOT NULL REFERENCES tag(id) ON DELETE CASCADE,
  org_id VARCHAR(255) NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  created_by VARCHAR(255) NOT NULL DEFAULT 'system',
  PRIMARY KEY (entity_id, tag_id)
);

CREATE INDEX IF NOT EXISTS entity_tag_entity_idx ON entity_tag(org_id, entity_id);
CREATE INDEX IF NOT EXISTS entity_tag_tag_idx ON entity_tag(tag_id);
```

## Verification Steps

1. Type check: `bun run tsc --noEmit` in packages/domain and packages/core
2. Migration test: Run `bun packages/core/migrations/0003_tag.ts`
3. Integration: All handlers wire up without errors
4. RPC test: Tag endpoints available at /api/rpc

## Unresolved Questions

None - design is straightforward following established patterns.
